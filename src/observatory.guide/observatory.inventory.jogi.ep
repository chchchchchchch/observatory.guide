{"pad:observatory.inventory.jogi:revs:0":{"changeset":"Z:1>17x|p+17x$from jogi@mur.at to [Observatory] When dirty.db get's dirty\n\nDear all,\n\nas promised yesterday, here my little report regarding the broken\netherpad.\n\n<md>\n### When dirty.db get's dirty   \n\nWhen I got to WTC on Monday morning the etherpad on etherbox.local was disfunct.  Later someone said that in fact etherpad had stopped working\nthe evening before, but it was unclear why.  So I started looking around the pi's filesystem to find out what was wrong. Took me a while to\nfind the relevant lines in /var/log/syslog but it became clear that there was a problem with the database.  Which database? Where does\netherpad 'live'?  I found it in /opt/etherpad and in a subdirectory named var/ there it was: dirty.db, and dirty it was.                                                                   \n                                \nA first look at the file revealed no apparent problem.  The last lines looked like this:\n    \n```                                                                   \n{\"key\":\"sessionstorage:Ddy0gw7okwbkv5BzkR1DuSLCV_IA5_jQ\",\"val\":{\"cookie\n\":{\"path\":\"/\",\"_expires\":null,\"originalMaxAge\":null,\"httpOnly\":true,\"secure\":false}}}                                                         \n{\"key\":\"sessionstorage:AU1cffgcTf_q6BV9aIdAvES2YyXM7Gm1\",\"val\":{\"cookie\n\":{\"path\":\"/\",\"_expires\":null,\"originalMaxAge\":null,\"httpOnly\":true,\"secure\":false}}}                                                         \n{\"key\":\"sessionstorage:_H5SdUlDvQ3XCuPaZEXQ5lx0K6aAEJ9m\",\"val\":{\"cookie\n\":{\"path\":\"/\",\"_expires\":null,\"originalMaxAge\":null,\"httpOnly\":true,\"se\ncure\":false}}}\n","meta":{"author":"","timestamp":1512742111230,"atext":{"text":"from jogi@mur.at to [Observatory] When dirty.db get's dirty\n\nDear all,\n\nas promised yesterday, here my little report regarding the broken\netherpad.\n\n<md>\n### When dirty.db get's dirty   \n\nWhen I got to WTC on Monday morning the etherpad on etherbox.local was disfunct.  Later someone said that in fact etherpad had stopped working\nthe evening before, but it was unclear why.  So I started looking around the pi's filesystem to find out what was wrong. Took me a while to\nfind the relevant lines in /var/log/syslog but it became clear that there was a problem with the database.  Which database? Where does\netherpad 'live'?  I found it in /opt/etherpad and in a subdirectory named var/ there it was: dirty.db, and dirty it was.                                                                   \n                                \nA first look at the file revealed no apparent problem.  The last lines looked like this:\n    \n```                                                                   \n{\"key\":\"sessionstorage:Ddy0gw7okwbkv5BzkR1DuSLCV_IA5_jQ\",\"val\":{\"cookie\n\":{\"path\":\"/\",\"_expires\":null,\"originalMaxAge\":null,\"httpOnly\":true,\"secure\":false}}}                                                         \n{\"key\":\"sessionstorage:AU1cffgcTf_q6BV9aIdAvES2YyXM7Gm1\",\"val\":{\"cookie\n\":{\"path\":\"/\",\"_expires\":null,\"originalMaxAge\":null,\"httpOnly\":true,\"secure\":false}}}                                                         \n{\"key\":\"sessionstorage:_H5SdUlDvQ3XCuPaZEXQ5lx0K6aAEJ9m\",\"val\":{\"cookie\n\":{\"path\":\"/\",\"_expires\":null,\"originalMaxAge\":null,\"httpOnly\":true,\"se\ncure\":false}}}\n\n","attribs":"|q+17y"}}},"pad:observatory.inventory.jogi:revs:1":{"changeset":"Z:17y>tj|p=17x|p+tj$```\n\nWhat I did not see at the time was that there were some (AFAIR\nsomething around 150) binary zeroes at the end of the file.  I used\ntail for the first look and that tool silently ignored the zeroes at\nthe end of the file.  It was Martino who suggested using different\ntools (xxd in that case) and that showed the cause of the problem.  The\nfile looked something like this:\n\n```\n00013730: 6f6b 6965 223a 7b22 7061 7468 223a 222f  okie\":{\"path\":\"/\n00013740: 222c 225f 6578 7069 7265 7322 3a6e 756c  \",\"_expires\":nul\n00013750: 6c2c 226f 7269 6769 6e61 6c4d 6178 4167  l,\"originalMaxAg\n00013760: 6522 3a6e 756c 6c2c 2268 7474 704f 6e6c  e\":null,\"httpOnl\n00013770: 7922 3a74 7275 652c 2273 6563 7572 6522  y\":true,\"secure\"\n00013780: 3a66 616c 7365 7d7d 7d0a 0000 0000 0000  :false}}}.......\n00013790: 0000 0000 0000 0000 0000 0000 0000 0000  ................\n```\n\nSo Anita, Martino and I stuck our heads together to come up with a\nsolution.  Our first attempt to fix the problem went something like\nthis:\n\n```\ndd if=dirty.db of=dirty.db.clean bs=1 count=793080162\n","meta":{"author":"","timestamp":1512742111318}},"pad:observatory.inventory.jogi:revs:2":{"changeset":"Z:21h>xa|1e=21g|p+xa$```\n\nwhich means: write the first 793080162 blocks of size 1 byte to a new\nfile.  After half an hour or so I checked on the size of the new file\nand saw that some 10% of the copying had been done.  No way this would\nget done in time for the walk-in-clinic.  Back to the drawing board.\n\nUsing a text editor was no real option btw since even vim has a hard\ntime with binary zeroes and the file was really big.  But there was\nhexedit!  Martino installed it and copied dirty.db onto his\ncomputer.  After some getting used to the various commands to navigate\nin hexedit the unwanted zeroes were gone in an instant.  The end of the\nfile looked like this now:\n\n```\n00013730: 6f6b 6965 223a 7b22 7061 7468 223a 222f  okie\":{\"path\":\"/\n00013740: 222c 225f 6578 7069 7265 7322 3a6e 756c  \",\"_expires\":nul\n00013750: 6c2c 226f 7269 6769 6e61 6c4d 6178 4167  l,\"originalMaxAg\n00013760: 6522 3a6e 756c 6c2c 2268 7474 704f 6e6c  e\":null,\"httpOnl\n00013770: 7922 3a74 7275 652c 2273 6563 7572 6522  y\":true,\"secure\"\n00013780: 3a66 616c 7365 7d7d 7d0a                 :false}}}.\n```\n\nMartino asked about the trailing '.' character and I checked a\ndifferent copy of the file.  No '.' there, so that had to go too.  My\n","meta":{"author":"","timestamp":1512742111401}},"pad:observatory.inventory.jogi:revs:3":{"changeset":"Z:2yr>13x|23=2yq|p+13x$biggest mistake in a long time!  The '.' we were seeing in Martino's\ncopy of the file was in fact a '\\n' (0a)!  We did not realize that,\ncopied the file back to etherbox.local and waited for etherpad to\nresume it's work.  But no luck there, for obvious reasons.\n\nWe ended up making backups of dirty.db in various stages of deformation\nand Martino started a brandnew pad so we could use pads for the walk-\nin-clinic.  The processing tool chain has been disabled btw.  We did\nnot want to mess up any of the already generated .pdf, .html and .md\nfiles.\n\nWe still don't know why exactly etherpad stopped working sometime\nSunday evening or how the zeroes got into the file dirty.db.  Anita\nthought that she caused the error when she adjusted time on\netherbox.local, but the logfile does not reflect that.  The last clean\nentry in /var/log/syslog regarding nodejs/etherpad is recorded with a\ntimestamp of something along the line of 'Jun 10 10:17'.  Some minutes\nlater, around 'Jun 10 10:27' the first error appears.  These timestamps\nreflect the etherbox's understanding of time btw, not 'real time'.\n\nIt might be that the file just got too big for etherpad to handle\nit.  The size of the repaired dirty.db file was already 757MB.  That\ncould btw explain why etherpad was working somewhat slugishly after\nsome days.  There is still a chance that the time adjustment had an\nunwanted side effect, but so far there is no obvious reason for what\n","meta":{"author":"","timestamp":1512742111488}},"pad:observatory.inventory.jogi:revs:4":{"changeset":"Z:42o>1y|2s=42n|6+1y$had happened.\n</md>\n-- \nJ.Hofmüller\n\n           http://thesix.mur.at/\n","meta":{"author":"","timestamp":1512742111574}},"pad:observatory.inventory.jogi:revs:5":{"changeset":"Z:44m<2wp|2z-44m|p+17x$from jogi@mur.at to [Observatory] When dirty.db get's dirty\n\nDear all,\n\nas promised yesterday, here my little report regarding the broken\netherpad.\n\n<md>\n### When dirty.db get's dirty   \n\nWhen I got to WTC on Monday morning the etherpad on etherbox.local was disfunct.  Later someone said that in fact etherpad had stopped working\nthe evening before, but it was unclear why.  So I started looking around the pi's filesystem to find out what was wrong. Took me a while to\nfind the relevant lines in /var/log/syslog but it became clear that there was a problem with the database.  Which database? Where does\netherpad 'live'?  I found it in /opt/etherpad and in a subdirectory named var/ there it was: dirty.db, and dirty it was.                                                                   \n                                \nA first look at the file revealed no apparent problem.  The last lines looked like this:\n    \n```                                                                   \n{\"key\":\"sessionstorage:Ddy0gw7okwbkv5BzkR1DuSLCV_IA5_jQ\",\"val\":{\"cookie\n\":{\"path\":\"/\",\"_expires\":null,\"originalMaxAge\":null,\"httpOnly\":true,\"secure\":false}}}                                                         \n{\"key\":\"sessionstorage:AU1cffgcTf_q6BV9aIdAvES2YyXM7Gm1\",\"val\":{\"cookie\n\":{\"path\":\"/\",\"_expires\":null,\"originalMaxAge\":null,\"httpOnly\":true,\"secure\":false}}}                                                         \n{\"key\":\"sessionstorage:_H5SdUlDvQ3XCuPaZEXQ5lx0K6aAEJ9m\",\"val\":{\"cookie\n\":{\"path\":\"/\",\"_expires\":null,\"originalMaxAge\":null,\"httpOnly\":true,\"se\ncure\":false}}}\n","meta":{"author":"","timestamp":1513950493762}},"pad:observatory.inventory.jogi:revs:6":{"changeset":"Z:17x>tj|o=17i=e|p+tj$```\n\nWhat I did not see at the time was that there were some (AFAIR\nsomething around 150) binary zeroes at the end of the file.  I used\ntail for the first look and that tool silently ignored the zeroes at\nthe end of the file.  It was Martino who suggested using different\ntools (xxd in that case) and that showed the cause of the problem.  The\nfile looked something like this:\n\n```\n00013730: 6f6b 6965 223a 7b22 7061 7468 223a 222f  okie\":{\"path\":\"/\n00013740: 222c 225f 6578 7069 7265 7322 3a6e 756c  \",\"_expires\":nul\n00013750: 6c2c 226f 7269 6769 6e61 6c4d 6178 4167  l,\"originalMaxAg\n00013760: 6522 3a6e 756c 6c2c 2268 7474 704f 6e6c  e\":null,\"httpOnl\n00013770: 7922 3a74 7275 652c 2273 6563 7572 6522  y\":true,\"secure\"\n00013780: 3a66 616c 7365 7d7d 7d0a 0000 0000 0000  :false}}}.......\n00013790: 0000 0000 0000 0000 0000 0000 0000 0000  ................\n```\n\nSo Anita, Martino and I stuck our heads together to come up with a\nsolution.  Our first attempt to fix the problem went something like\nthis:\n\n```\ndd if=dirty.db of=dirty.db.clean bs=1 count=793080162\n","meta":{"author":"","timestamp":1513950493841}},"pad:observatory.inventory.jogi:revs:7":{"changeset":"Z:21g>xa|1d=21f|p+xa$```\n\nwhich means: write the first 793080162 blocks of size 1 byte to a new\nfile.  After half an hour or so I checked on the size of the new file\nand saw that some 10% of the copying had been done.  No way this would\nget done in time for the walk-in-clinic.  Back to the drawing board.\n\nUsing a text editor was no real option btw since even vim has a hard\ntime with binary zeroes and the file was really big.  But there was\nhexedit!  Martino installed it and copied dirty.db onto his\ncomputer.  After some getting used to the various commands to navigate\nin hexedit the unwanted zeroes were gone in an instant.  The end of the\nfile looked like this now:\n\n```\n00013730: 6f6b 6965 223a 7b22 7061 7468 223a 222f  okie\":{\"path\":\"/\n00013740: 222c 225f 6578 7069 7265 7322 3a6e 756c  \",\"_expires\":nul\n00013750: 6c2c 226f 7269 6769 6e61 6c4d 6178 4167  l,\"originalMaxAg\n00013760: 6522 3a6e 756c 6c2c 2268 7474 704f 6e6c  e\":null,\"httpOnl\n00013770: 7922 3a74 7275 652c 2273 6563 7572 6522  y\":true,\"secure\"\n00013780: 3a66 616c 7365 7d7d 7d0a                 :false}}}.\n```\n\nMartino asked about the trailing '.' character and I checked a\ndifferent copy of the file.  No '.' there, so that had to go too.  My\n","meta":{"author":"","timestamp":1513950493922}},"pad:observatory.inventory.jogi:revs:8":{"changeset":"Z:2yq>13x|22=2yp|p+13x$biggest mistake in a long time!  The '.' we were seeing in Martino's\ncopy of the file was in fact a '\\n' (0a)!  We did not realize that,\ncopied the file back to etherbox.local and waited for etherpad to\nresume it's work.  But no luck there, for obvious reasons.\n\nWe ended up making backups of dirty.db in various stages of deformation\nand Martino started a brandnew pad so we could use pads for the walk-\nin-clinic.  The processing tool chain has been disabled btw.  We did\nnot want to mess up any of the already generated .pdf, .html and .md\nfiles.\n\nWe still don't know why exactly etherpad stopped working sometime\nSunday evening or how the zeroes got into the file dirty.db.  Anita\nthought that she caused the error when she adjusted time on\netherbox.local, but the logfile does not reflect that.  The last clean\nentry in /var/log/syslog regarding nodejs/etherpad is recorded with a\ntimestamp of something along the line of 'Jun 10 10:17'.  Some minutes\nlater, around 'Jun 10 10:27' the first error appears.  These timestamps\nreflect the etherbox's understanding of time btw, not 'real time'.\n\nIt might be that the file just got too big for etherpad to handle\nit.  The size of the repaired dirty.db file was already 757MB.  That\ncould btw explain why etherpad was working somewhat slugishly after\nsome days.  There is still a chance that the time adjustment had an\nunwanted side effect, but so far there is no obvious reason for what\n","meta":{"author":"","timestamp":1513950494001}},"pad:observatory.inventory.jogi:revs:9":{"changeset":"Z:42n>1y|2r=42m|6+1y$had happened.\n</md>\n-- \nJ.Hofmüller\n\n           http://thesix.mur.at/\n","meta":{"author":"","timestamp":1513950494080}},"pad:observatory.inventory.jogi":{"atext":{"text":"from jogi@mur.at to [Observatory] When dirty.db get's dirty\n\nDear all,\n\nas promised yesterday, here my little report regarding the broken\netherpad.\n\n<md>\n### When dirty.db get's dirty   \n\nWhen I got to WTC on Monday morning the etherpad on etherbox.local was disfunct.  Later someone said that in fact etherpad had stopped working\nthe evening before, but it was unclear why.  So I started looking around the pi's filesystem to find out what was wrong. Took me a while to\nfind the relevant lines in /var/log/syslog but it became clear that there was a problem with the database.  Which database? Where does\netherpad 'live'?  I found it in /opt/etherpad and in a subdirectory named var/ there it was: dirty.db, and dirty it was.                                                                   \n                                \nA first look at the file revealed no apparent problem.  The last lines looked like this:\n    \n```                                                                   \n{\"key\":\"sessionstorage:Ddy0gw7okwbkv5BzkR1DuSLCV_IA5_jQ\",\"val\":{\"cookie\n\":{\"path\":\"/\",\"_expires\":null,\"originalMaxAge\":null,\"httpOnly\":true,\"secure\":false}}}                                                         \n{\"key\":\"sessionstorage:AU1cffgcTf_q6BV9aIdAvES2YyXM7Gm1\",\"val\":{\"cookie\n\":{\"path\":\"/\",\"_expires\":null,\"originalMaxAge\":null,\"httpOnly\":true,\"secure\":false}}}                                                         \n{\"key\":\"sessionstorage:_H5SdUlDvQ3XCuPaZEXQ5lx0K6aAEJ9m\",\"val\":{\"cookie\n\":{\"path\":\"/\",\"_expires\":null,\"originalMaxAge\":null,\"httpOnly\":true,\"se\ncure\":false}}}```\n\nWhat I did not see at the time was that there were some (AFAIR\nsomething around 150) binary zeroes at the end of the file.  I used\ntail for the first look and that tool silently ignored the zeroes at\nthe end of the file.  It was Martino who suggested using different\ntools (xxd in that case) and that showed the cause of the problem.  The\nfile looked something like this:\n\n```\n00013730: 6f6b 6965 223a 7b22 7061 7468 223a 222f  okie\":{\"path\":\"/\n00013740: 222c 225f 6578 7069 7265 7322 3a6e 756c  \",\"_expires\":nul\n00013750: 6c2c 226f 7269 6769 6e61 6c4d 6178 4167  l,\"originalMaxAg\n00013760: 6522 3a6e 756c 6c2c 2268 7474 704f 6e6c  e\":null,\"httpOnl\n00013770: 7922 3a74 7275 652c 2273 6563 7572 6522  y\":true,\"secure\"\n00013780: 3a66 616c 7365 7d7d 7d0a 0000 0000 0000  :false}}}.......\n00013790: 0000 0000 0000 0000 0000 0000 0000 0000  ................\n```\n\nSo Anita, Martino and I stuck our heads together to come up with a\nsolution.  Our first attempt to fix the problem went something like\nthis:\n\n```\ndd if=dirty.db of=dirty.db.clean bs=1 count=793080162\n```\n\nwhich means: write the first 793080162 blocks of size 1 byte to a new\nfile.  After half an hour or so I checked on the size of the new file\nand saw that some 10% of the copying had been done.  No way this would\nget done in time for the walk-in-clinic.  Back to the drawing board.\n\nUsing a text editor was no real option btw since even vim has a hard\ntime with binary zeroes and the file was really big.  But there was\nhexedit!  Martino installed it and copied dirty.db onto his\ncomputer.  After some getting used to the various commands to navigate\nin hexedit the unwanted zeroes were gone in an instant.  The end of the\nfile looked like this now:\n\n```\n00013730: 6f6b 6965 223a 7b22 7061 7468 223a 222f  okie\":{\"path\":\"/\n00013740: 222c 225f 6578 7069 7265 7322 3a6e 756c  \",\"_expires\":nul\n00013750: 6c2c 226f 7269 6769 6e61 6c4d 6178 4167  l,\"originalMaxAg\n00013760: 6522 3a6e 756c 6c2c 2268 7474 704f 6e6c  e\":null,\"httpOnl\n00013770: 7922 3a74 7275 652c 2273 6563 7572 6522  y\":true,\"secure\"\n00013780: 3a66 616c 7365 7d7d 7d0a                 :false}}}.\n```\n\nMartino asked about the trailing '.' character and I checked a\ndifferent copy of the file.  No '.' there, so that had to go too.  My\nbiggest mistake in a long time!  The '.' we were seeing in Martino's\ncopy of the file was in fact a '\\n' (0a)!  We did not realize that,\ncopied the file back to etherbox.local and waited for etherpad to\nresume it's work.  But no luck there, for obvious reasons.\n\nWe ended up making backups of dirty.db in various stages of deformation\nand Martino started a brandnew pad so we could use pads for the walk-\nin-clinic.  The processing tool chain has been disabled btw.  We did\nnot want to mess up any of the already generated .pdf, .html and .md\nfiles.\n\nWe still don't know why exactly etherpad stopped working sometime\nSunday evening or how the zeroes got into the file dirty.db.  Anita\nthought that she caused the error when she adjusted time on\netherbox.local, but the logfile does not reflect that.  The last clean\nentry in /var/log/syslog regarding nodejs/etherpad is recorded with a\ntimestamp of something along the line of 'Jun 10 10:17'.  Some minutes\nlater, around 'Jun 10 10:27' the first error appears.  These timestamps\nreflect the etherbox's understanding of time btw, not 'real time'.\n\nIt might be that the file just got too big for etherpad to handle\nit.  The size of the repaired dirty.db file was already 757MB.  That\ncould btw explain why etherpad was working somewhat slugishly after\nsome days.  There is still a chance that the time adjustment had an\nunwanted side effect, but so far there is no obvious reason for what\nhad happened.\n</md>\n-- \nJ.Hofmüller\n\n           http://thesix.mur.at/\n\n","attribs":"|2y+44l"},"pool":{"numToAttrib":{},"nextNum":0},"head":9,"chatHead":-1,"publicStatus":false,"passwordHash":null,"savedRevisions":[]}}